<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑剧本 - 短剧创作后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.18/24/outline/heroicons.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        /* 消息提示框样式 */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 1050; /* Higher than modal */
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .message-box.success { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .message-box.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .message-box.info { background-color: #e0e7ff; color: #3730a3; border: 1px solid #a5b4fc; }

        /* 文本域自定义高度 */
        textarea { min-height: 80px; }
        .modal-textarea { min-height: 100px; }
        .param-modal-textarea { min-height: 60px; } /* For prompt textareas in new modal */

        /* Tab 样式 */
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            background-color: #eef2ff; /* indigo-50 */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Accordion 样式 */
        .accordion-header { cursor: pointer; }
        .accordion-content { display: none; }
        .accordion-content.open { display: block; }

        /* Modal 样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto; 
        }
        .modal.open { display: flex; }
        .modal-content {
            background-color: white;
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 500px; /* Adjusted for checkpoint params modal */
            max-height: 90vh; 
            overflow-y: auto;
        }
         .settings-modal-content { /* Specific for main settings modal */
            max-width: 600px;
        }

        .fixed-settings-btn {
            position: fixed;
            bottom: 2rem; 
            right: 2rem; 
            z-index: 900;
        }

        /* LORA item styling */
        .lora-item .slider-value {
            min-width: 2.5rem; 
        }
        .generated-image-display {
            background-color: #e5e7eb; 
            border-radius: 0.5rem; 
            display: flex;
            flex-direction: column; /* Stack images vertically if multiple */
            align-items: center;
            justify-content: center;
            min-height: 300px; 
            overflow-y: auto; /* Allow scrolling for many images */
        }
        .generated-image-display.grid-display { /* For multiple images side-by-side */
            display: grid;
            align-items: start;
        }

        @media (min-width: 768px) { 
            .generated-image-display {
                min-height: 450px; 
            }
        }
        /* Dropdown for image count */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffffff;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10; /* Ensure dropdown is above other elements */
            border-radius: 0.375rem; 
            padding: 0.5rem 0; 
            margin-bottom: 0.5rem; 
        }
        .dropdown-content button {
            color: black;
            padding: 0.5rem 1rem; 
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .dropdown-content button:hover {background-color: #f1f1f1;}
        .dropdown.open .dropdown-content {display: block;}

        /* Checkpoint param modal input styling */
        .param-modal-input {
            background-color: #f3f4f6; /* gray-100 */
            border-color: #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="short_drama_backend_ui.html" id="back-to-list-btn-header" class="flex items-center text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        返回剧本列表
                    </a>
                </div>
                <h1 class="text-xl font-semibold text-gray-900">编辑剧本: <span id="script-title-display">都市狂龙</span></h1>
                <div class="w-auto sm:w-36"></div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-4 sm:space-x-8" aria-label="Tabs">
                <button data-tab-target="#roles-tab" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    角色编辑
                </button>
                <button data-tab-target="#storyboards-tab" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    分镜编辑
                </button>
            </nav>
        </div>

        <div>
            <div id="roles-tab" class="tab-content active">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">角色设定</h2>
                <div id="roles-accordion-container" class="space-y-3">
                    <div class="accordion-item bg-white rounded-md shadow">
                        <div class="accordion-header flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 class="text-md font-medium text-gray-900">角色A: 李明 (男主角)</h3>
                            <svg class="accordion-icon h-5 w-5 text-gray-500 transform transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="accordion-content p-4 space-y-6">
                            <div class="editable-section p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">形象设定 1: 日常装扮</h4>
                                <div class="flex flex-col md:flex-row gap-x-6 gap-y-4">
                                    <div class="w-full md:w-1/3 lg:w-1/4 space-y-4 order-2 md:order-1">
                                        <div class="space-y-1">
                                            <label for="base-model-1" class="block text-sm font-medium text-gray-700">基础模型</label>
                                            <div class="flex items-center space-x-2">
                                                <select id="base-model-1" name="base-model-1" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                                    <option>星流 Star-3 (推荐)</option>
                                                    <option>通用模型 v2.0</option>
                                                </select>
                                                <button type="button" id="open-checkpoint-params-modal-1" class="p-2 border border-gray-300 rounded-md shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="设定Checkpoint参数">
                                                    <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">增强模型: LORA</label>
                                            <div id="lora-container-1" class="space-y-3">
                                                <div class="lora-item flex items-center space-x-3 p-3 bg-white border border-gray-300 rounded-md">
                                                    <img src="https://placehold.co/40x40/e0e7ff/4f46e5?text=LR" alt="LORA 预览" class="h-10 w-10 rounded object-cover">
                                                    <div class="flex-grow">
                                                        <span class="text-sm font-medium text-gray-800">自然感摄影</span>
                                                        <div class="flex items-center space-x-2 mt-1">
                                                            <input type="range" min="0" max="2" step="0.01" value="1.2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 lora-slider">
                                                            <span class="text-sm text-gray-600 slider-value">1.20</span>
                                                        </div>
                                                    </div>
                                                    <button type="button" class="text-gray-400 hover:text-red-500 remove-lora-btn"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-8.707-8.707a1 1 0 00-1.414-1.414L0 10l-1.293-1.293a1 1 0 00-1.414 1.414L1.414 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586z" clip-rule="evenodd" /></svg></button>
                                                </div>
                                            </div>
                                            <button type="button" class="add-lora-btn mt-2 inline-flex items-center px-3 py-1.5 border border-dashed border-gray-400 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 hover:border-gray-500"><svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>添加增强模型</button>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="prompt-1" class="block text-sm font-medium text-gray-700">提示词</label>
                                            <textarea id="prompt-1" name="prompt-1" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="例如：一位英俊的年轻男子..."></textarea>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="image-reference-input-1" class="block text-sm font-medium text-gray-700">图片参考 (可选)</label>
                                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                <div class="space-y-1 text-center">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                    <div class="flex text-sm text-gray-600"><label for="image-reference-input-1" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>上传文件</span><input id="image-reference-input-1" name="image-reference-input-1" type="file" class="sr-only image-file-input"></label><p class="pl-1">或拖拽</p></div><p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                                                </div>
                                            </div>
                                            <img src="https://placehold.co/300x200/e9ecef/6c757d?text=参考图预览1" alt="参考图预览" class="image-preview mt-2 rounded-md max-h-48 w-full object-contain block hidden">
                                        </div>
                                        <div class="pt-3 flex items-center justify-between bg-indigo-600 text-white rounded-md shadow-sm">
                                            <div class="dropdown image-count-dropdown relative">
                                                <button type="button" class="image-count-selector flex items-center px-3 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-l-md focus:outline-none"><span id="selected-image-count-1">1张</span><svg class="h-4 w-4 ml-1 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></button>
                                                <div class="dropdown-content hidden bg-white shadow-lg rounded-md py-1 w-24"><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="1">1张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="2">2张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="3">3张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="4">4张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="8">8张</button></div>
                                            </div>
                                            <div class="w-px h-6 bg-indigo-400"></div>
                                            <button type="button" class="generate-image-btn flex-grow inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-r-md focus:outline-none"><svg class="h-5 w-5 mr-2 icon-lightning" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg><span class="generate-text">生图</span><svg class="h-4 w-4 ml-1 icon-energy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.907a.75.75 0 00-1.19-.653L2.009 8.422a.75.75 0 00.653 1.19l6.091-1.624a.75.75 0 01.877.877l-1.624 6.091a.75.75 0 001.19.653l7.165-8.784a.75.75 0 00-.653-1.19L11.983 1.907z" /></svg><span class="generate-cost">1</span></button>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-2/3 lg:w-3/4 order-1 md:order-2">
                                        <div id="generated-image-area-1" class="generated-image-display"><div class="text-center p-4"><svg class="mx-auto h-16 w-16 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L12.5 7.5M12.5 12l1.06-1.06M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><p class="text-sm text-gray-500">生成的图片将在此处显示</p><p class="text-xs text-gray-400 mt-1">点击“生图”按钮开始</p></div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="editable-section p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">形象设定 2: 战斗装扮</h4>
                                <div class="flex flex-col md:flex-row gap-x-6 gap-y-4">
                                    <div class="w-full md:w-1/3 lg:w-1/4 space-y-4 order-2 md:order-1">
                                        <div class="space-y-1">
                                            <label for="base-model-2" class="block text-sm font-medium text-gray-700">基础模型</label>
                                            <div class="flex items-center space-x-2">
                                                <select id="base-model-2" name="base-model-2" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option>星流 Star-3 (推荐)</option><option>通用模型 v2.0</option></select>
                                                <button type="button" id="open-checkpoint-params-modal-2" class="p-2 border border-gray-300 rounded-md shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="设定Checkpoint参数"><svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">增强模型: LORA</label>
                                            <div id="lora-container-2" class="space-y-3"></div>
                                            <button type="button" class="add-lora-btn mt-2 inline-flex items-center px-3 py-1.5 border border-dashed border-gray-400 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 hover:border-gray-500"><svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>添加增强模型</button>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="prompt-2" class="block text-sm font-medium text-gray-700">提示词</label>
                                            <textarea id="prompt-2" name="prompt-2" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="例如：身着黑色劲装，手持长剑，眼神凌厉..."></textarea>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="image-reference-input-2" class="block text-sm font-medium text-gray-700">图片参考 (可选)</label>
                                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                <div class="space-y-1 text-center">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                    <div class="flex text-sm text-gray-600"><label for="image-reference-input-2" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>上传文件</span><input id="image-reference-input-2" name="image-reference-input-2" type="file" class="sr-only image-file-input"></label><p class="pl-1">或拖拽</p></div><p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                                                </div>
                                            </div>
                                            <img src="https://placehold.co/300x200/e9ecef/6c757d?text=参考图预览2" alt="参考图预览" class="image-preview mt-2 rounded-md max-h-48 w-full object-contain block hidden">
                                        </div>
                                        <div class="pt-3 flex items-center justify-between bg-indigo-600 text-white rounded-md shadow-sm">
                                            <div class="dropdown image-count-dropdown relative">
                                                <button type="button" class="image-count-selector flex items-center px-3 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-l-md focus:outline-none"><span id="selected-image-count-2">1张</span><svg class="h-4 w-4 ml-1 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></button>
                                                <div class="dropdown-content hidden bg-white shadow-lg rounded-md py-1 w-24"><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="1">1张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="2">2张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="3">3张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="4">4张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="8">8张</button></div>
                                            </div>
                                            <div class="w-px h-6 bg-indigo-400"></div>
                                            <button type="button" class="generate-image-btn flex-grow inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-r-md focus:outline-none"><svg class="h-5 w-5 mr-2 icon-lightning" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg><span class="generate-text">生图</span><svg class="h-4 w-4 ml-1 icon-energy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.907a.75.75 0 00-1.19-.653L2.009 8.422a.75.75 0 00.653 1.19l6.091-1.624a.75.75 0 01.877.877l-1.624 6.091a.75.75 0 001.19.653l7.165-8.784a.75.75 0 00-.653-1.19L11.983 1.907z" /></svg><span class="generate-cost">1</span></button>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-2/3 lg:w-3/4 order-1 md:order-2">
                                        <div id="generated-image-area-2" class="generated-image-display"><div class="text-center p-4"><svg class="mx-auto h-16 w-16 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L12.5 7.5M12.5 12l1.06-1.06M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><p class="text-sm text-gray-500">生成的图片将在此处显示</p><p class="text-xs text-gray-400 mt-1">点击“生图”按钮开始</p></div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="editable-section p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">形象设定 3: 特殊能力</h4>
                                <div class="flex flex-col md:flex-row gap-x-6 gap-y-4">
                                    <div class="w-full md:w-1/3 lg:w-1/4 space-y-4 order-2 md:order-1">
                                        <div class="space-y-1">
                                            <label for="base-model-3" class="block text-sm font-medium text-gray-700">基础模型</label>
                                            <div class="flex items-center space-x-2">
                                                <select id="base-model-3" name="base-model-3" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option>星流 Star-3 (推荐)</option><option>特效模型 v1.2</option></select>
                                                <button type="button" id="open-checkpoint-params-modal-3" class="p-2 border border-gray-300 rounded-md shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="设定Checkpoint参数"><svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">增强模型: LORA</label>
                                            <div id="lora-container-3" class="space-y-3"></div>
                                            <button type="button" class="add-lora-btn mt-2 inline-flex items-center px-3 py-1.5 border border-dashed border-gray-400 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 hover:border-gray-500"><svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>添加增强模型</button>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="prompt-3" class="block text-sm font-medium text-gray-700">提示词</label>
                                            <textarea id="prompt-3" name="prompt-3" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="例如：周身环绕火焰，目光如炬..."></textarea>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="image-reference-input-3" class="block text-sm font-medium text-gray-700">图片参考 (可选)</label>
                                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                <div class="space-y-1 text-center">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                    <div class="flex text-sm text-gray-600"><label for="image-reference-input-3" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>上传文件</span><input id="image-reference-input-3" name="image-reference-input-3" type="file" class="sr-only image-file-input"></label><p class="pl-1">或拖拽</p></div><p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                                                </div>
                                            </div>
                                            <img src="https://placehold.co/300x200/e9ecef/6c757d?text=参考图预览3" alt="参考图预览" class="image-preview mt-2 rounded-md max-h-48 w-full object-contain block hidden">
                                        </div>
                                        <div class="pt-3 flex items-center justify-between bg-indigo-600 text-white rounded-md shadow-sm">
                                            <div class="dropdown image-count-dropdown relative">
                                                <button type="button" class="image-count-selector flex items-center px-3 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-l-md focus:outline-none"><span id="selected-image-count-3">1张</span><svg class="h-4 w-4 ml-1 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></button>
                                                <div class="dropdown-content hidden bg-white shadow-lg rounded-md py-1 w-24"><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="1">1张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="2">2张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="3">3张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="4">4张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="8">8张</button></div>
                                            </div>
                                            <div class="w-px h-6 bg-indigo-400"></div>
                                            <button type="button" class="generate-image-btn flex-grow inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-r-md focus:outline-none"><svg class="h-5 w-5 mr-2 icon-lightning" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg><span class="generate-text">生图</span><svg class="h-4 w-4 ml-1 icon-energy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.907a.75.75 0 00-1.19-.653L2.009 8.422a.75.75 0 00.653 1.19l6.091-1.624a.75.75 0 01.877.877l-1.624 6.091a.75.75 0 001.19.653l7.165-8.784a.75.75 0 00-.653-1.19L11.983 1.907z" /></svg><span class="generate-cost">1</span></button>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-2/3 lg:w-3/4 order-1 md:order-2">
                                        <div id="generated-image-area-3" class="generated-image-display"><div class="text-center p-4"><svg class="mx-auto h-16 w-16 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L12.5 7.5M12.5 12l1.06-1.06M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><p class="text-sm text-gray-500">生成的图片将在此处显示</p><p class="text-xs text-gray-400 mt-1">点击“生图”按钮开始</p></div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="editable-section p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">形象设定 4: Q版形象</h4>
                                <div class="flex flex-col md:flex-row gap-x-6 gap-y-4">
                                    <div class="w-full md:w-1/3 lg:w-1/4 space-y-4 order-2 md:order-1">
                                        <div class="space-y-1">
                                            <label for="base-model-4" class="block text-sm font-medium text-gray-700">基础模型</label>
                                            <div class="flex items-center space-x-2">
                                                <select id="base-model-4" name="base-model-4" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option>Q版专用模型 v1.0</option><option>星流 Star-3 (推荐)</option></select>
                                                <button type="button" id="open-checkpoint-params-modal-4" class="p-2 border border-gray-300 rounded-md shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="设定Checkpoint参数"><svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">增强模型: LORA</label>
                                            <div id="lora-container-4" class="space-y-3"></div>
                                            <button type="button" class="add-lora-btn mt-2 inline-flex items-center px-3 py-1.5 border border-dashed border-gray-400 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 hover:border-gray-500"><svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>添加增强模型</button>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="prompt-4" class="block text-sm font-medium text-gray-700">提示词</label>
                                            <textarea id="prompt-4" name="prompt-4" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="例如：大头娃娃，圆脸，可爱表情..."></textarea>
                                        </div>
                                        <div class="space-y-1">
                                            <label for="image-reference-input-4" class="block text-sm font-medium text-gray-700">图片参考 (可选)</label>
                                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                <div class="space-y-1 text-center">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                    <div class="flex text-sm text-gray-600"><label for="image-reference-input-4" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500"><span>上传文件</span><input id="image-reference-input-4" name="image-reference-input-4" type="file" class="sr-only image-file-input"></label><p class="pl-1">或拖拽</p></div><p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                                                </div>
                                            </div>
                                            <img src="https://placehold.co/300x200/e9ecef/6c757d?text=参考图预览4" alt="参考图预览" class="image-preview mt-2 rounded-md max-h-48 w-full object-contain block hidden">
                                        </div>
                                        <div class="pt-3 flex items-center justify-between bg-indigo-600 text-white rounded-md shadow-sm">
                                            <div class="dropdown image-count-dropdown relative">
                                                <button type="button" class="image-count-selector flex items-center px-3 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-l-md focus:outline-none"><span id="selected-image-count-4">1张</span><svg class="h-4 w-4 ml-1 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></button>
                                                <div class="dropdown-content hidden bg-white shadow-lg rounded-md py-1 w-24"><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="1">1张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="2">2张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="3">3张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="4">4张</button><button type="button" class="dropdown-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-count="8">8张</button></div>
                                            </div>
                                            <div class="w-px h-6 bg-indigo-400"></div>
                                            <button type="button" class="generate-image-btn flex-grow inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium hover:bg-indigo-700 rounded-r-md focus:outline-none"><svg class="h-5 w-5 mr-2 icon-lightning" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg><span class="generate-text">生图</span><svg class="h-4 w-4 ml-1 icon-energy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.907a.75.75 0 00-1.19-.653L2.009 8.422a.75.75 0 00.653 1.19l6.091-1.624a.75.75 0 01.877.877l-1.624 6.091a.75.75 0 001.19.653l7.165-8.784a.75.75 0 00-.653-1.19L11.983 1.907z" /></svg><span class="generate-cost">1</span></button>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-2/3 lg:w-3/4 order-1 md:order-2">
                                        <div id="generated-image-area-4" class="generated-image-display"><div class="text-center p-4"><svg class="mx-auto h-16 w-16 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L12.5 7.5M12.5 12l1.06-1.06M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><p class="text-sm text-gray-500">生成的图片将在此处显示</p><p class="text-xs text-gray-400 mt-1">点击“生图”按钮开始</p></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item bg-white rounded-md shadow">
                         <div class="accordion-header flex justify-between items-center p-4">
                            <h3 class="text-md font-medium text-gray-900">角色B: 王雪 (女主角)</h3>
                            <svg class="accordion-icon h-5 w-5 text-gray-500 transform transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="accordion-content p-4 space-y-6">
                            <p class="text-sm text-gray-500">角色B的详细设定区域...</p>
                        </div>
                    </div>
                </div>
          
            </div>

            <div id="storyboards-tab" class="tab-content">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">分镜设计</h2>
                </div>
        </div>
    </main>

    <button id="open-settings-modal-btn" class="fixed-settings-btn p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>
    <div id="settings-modal" class="modal">
        <div class="modal-content settings-modal-content">
            </div>
    </div>

    <div id="checkpoint-params-modal" class="modal">
        <div class="modal-content">
            </div>
    </div>

    <div id="message-box-container"></div>

    <script>
        // --- Message Box Function (unchanged) ---
        function showMessage(message, type = 'info', duration = 3000) {
            const container = document.getElementById('message-box-container');
            if (!container) return;
            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}`;
            messageBox.textContent = message;
            container.appendChild(messageBox);
            setTimeout(() => messageBox.classList.add('show'), 10);
            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.addEventListener('transitionend', () => messageBox.remove(), { once: true });
            }, duration);
        }

        // --- Tab Functionality (unchanged) ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = document.querySelector(button.dataset.tabTarget);
                tabContents.forEach(content => content.classList.remove('active'));
                if (targetTab) targetTab.classList.add('active');
            });
        });

        // --- Accordion Functionality (unchanged) ---
        function initializeAccordionEvents(containerSelector) {
            const accordionContainer = document.querySelector(containerSelector);
            if (!accordionContainer) return;
            accordionContainer.addEventListener('click', function(event) {
                const header = event.target.closest('.accordion-header');
                if (!header) return;
                const item = header.parentElement;
                const content = item.querySelector('.accordion-content');
                const icon = header.querySelector('.accordion-icon');
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    if (icon) icon.classList.remove('rotate-180');
                } else {
                    content.classList.add('open');
                    if (icon) icon.classList.add('rotate-180');
                }
            });
        }
        initializeAccordionEvents('#roles-accordion-container');
        initializeAccordionEvents('#storyboards-accordion-container');
        
        // --- Initialize dynamic elements for ALL editable sections ---
        function initializeEditableSection(section, sectionIndex) {
            // Image Preview
            const imageInput = section.querySelector('.image-file-input');
            if (imageInput) {
                imageInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        const previewElement = imageInput.closest('.space-y-1').querySelector('.image-preview');
                        reader.onload = function(e) {
                            if(previewElement) {
                                previewElement.src = e.target.result;
                                previewElement.classList.remove('hidden');
                            }
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            // LORA Sliders
            initializeLoraSliders(section.querySelector('[id^="lora-container-"]'));
            
            // Add/Remove LORA
            const addLoraBtn = section.querySelector('.add-lora-btn');
            const loraContainer = section.querySelector('[id^="lora-container-"]');
            if (addLoraBtn && loraContainer) {
                addLoraBtn.addEventListener('click', () => {
                    const loraCount = loraContainer.querySelectorAll('.lora-item').length + 1;
                    const newLoraHTML = `
                        <div class="lora-item flex items-center space-x-3 p-3 bg-white border border-gray-300 rounded-md">
                            <img src="https://placehold.co/40x40/d1d5db/4b5563?text=L${loraCount}" alt="LORA 预览" class="h-10 w-10 rounded object-cover">
                            <div class="flex-grow">
                                <span class="text-sm font-medium text-gray-800">新增LORA ${loraCount}</span>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="range" min="0" max="2" step="0.01" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 lora-slider">
                                    <span class="text-sm text-gray-600 slider-value">1.00</span>
                                </div>
                            </div>
                            <button type="button" class="text-gray-400 hover:text-red-500 remove-lora-btn"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-8.707-8.707a1 1 0 00-1.414-1.414L0 10l-1.293-1.293a1 1 0 00-1.414 1.414L1.414 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586z" clip-rule="evenodd" /></svg></button>
                        </div>`;
                    loraContainer.insertAdjacentHTML('beforeend', newLoraHTML);
                    initializeLoraSliders(loraContainer.lastElementChild);
                });
            }
            if (loraContainer) {
                loraContainer.addEventListener('click', function(event) {
                    const removeButton = event.target.closest('.remove-lora-btn');
                    if (removeButton) removeButton.closest('.lora-item').remove();
                });
            }

            // Image Count Dropdown
            const dropdown = section.querySelector('.image-count-dropdown');
            const selectorButton = section.querySelector('.image-count-selector');
            const dropdownContent = section.querySelector('.dropdown-content');
            const selectedCountSpan = section.querySelector(`#selected-image-count-${sectionIndex + 1}`);
            const generateBtn = section.querySelector('.generate-image-btn');
            const generateCostSpan = generateBtn ? generateBtn.querySelector('.generate-cost') : null;

            if (selectorButton && dropdownContent && selectedCountSpan && generateBtn) {
                selectorButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    document.querySelectorAll('.image-count-dropdown .dropdown-content').forEach(otherContent => {
                        if (otherContent !== dropdownContent) otherContent.classList.add('hidden');
                    });
                    dropdownContent.classList.toggle('hidden');
                });
                dropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const count = item.dataset.count;
                        selectedCountSpan.textContent = `${count}张`;
                        if (generateCostSpan) generateCostSpan.textContent = count;
                        dropdownContent.classList.add('hidden');
                    });
                });
            }

            // Generate Image Button
            if (generateBtn) {
                 generateBtn.addEventListener('click', (event) => {
                    const currentCount = selectedCountSpan ? parseInt(selectedCountSpan.textContent.replace('张','')) : 1;
                    showMessage(`开始生成 ${currentCount} 张图片... (模拟)`, 'success');
                    const imageDisplayArea = section.querySelector(`#generated-image-area-${sectionIndex + 1}`);
                    if (imageDisplayArea) {
                        imageDisplayArea.innerHTML = ''; 
                        imageDisplayArea.classList.remove('grid', 'grid-cols-2', 'gap-2'); // Reset grid
                        
                        for(let i = 0; i < currentCount; i++) {
                            const imgElement = document.createElement('img');
                            imgElement.src = `https://placehold.co/400x300/1f2937/ffffff?text=图${i+1}-${Date.now()}`;
                            imgElement.alt = `生成的图片 ${i+1}`;
                            imgElement.className = "w-full h-auto object-contain rounded-md";
                            if (currentCount > 1) imgElement.classList.add("mb-2"); // Add margin if multiple
                            imageDisplayArea.appendChild(imgElement);
                        }
                        if(currentCount > 1 && currentCount <= 4) { // Apply grid for 2-4 images
                             imageDisplayArea.classList.add('grid', 'grid-cols-2', 'gap-2'); 
                        } else if (currentCount > 4) { // Could be a different grid for more images
                             imageDisplayArea.classList.add('grid', 'grid-cols-2', 'sm:grid-cols-3', 'lg:grid-cols-4', 'gap-2');
                        }
                    }
                });
            }
            
            // Checkpoint Params Modal Button
            const openCheckpointBtn = section.querySelector(`#open-checkpoint-params-modal-${sectionIndex + 1}`);
            if (openCheckpointBtn) {
                openCheckpointBtn.addEventListener('click', () => {
                    // Here you might want to pass which section's params are being edited
                    // For now, it just opens the single shared modal.
                    const checkpointParamsModal = document.getElementById('checkpoint-params-modal');
                    if (checkpointParamsModal) checkpointParamsModal.classList.add('open');
                });
            }
        }
        
        document.querySelectorAll('.editable-section').forEach((section, index) => {
            initializeEditableSection(section, index);
        });
        
        document.addEventListener('click', (event) => { // Close dropdowns on outside click
            document.querySelectorAll('.image-count-dropdown .dropdown-content').forEach(content => {
                if (!content.classList.contains('hidden') && !content.parentElement.contains(event.target)) {
                    content.classList.add('hidden');
                }
            });
        });

        // --- Settings Modal Functionality (unchanged) ---
        const settingsModal = document.getElementById('settings-modal');
        const openModalBtn = document.getElementById('open-settings-modal-btn');
        const closeModalBtn = document.getElementById('close-settings-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const editScriptInfoForm = document.getElementById('edit-script-info-form');
        const scriptTitleDisplay = document.getElementById('script-title-display');
        if (openModalBtn) openModalBtn.addEventListener('click', () => settingsModal.classList.add('open'));
        if (closeModalBtn) closeModalBtn.addEventListener('click', () => settingsModal.classList.remove('open'));
        if (cancelModalBtn) cancelModalBtn.addEventListener('click', () => settingsModal.classList.remove('open'));
        if (settingsModal) { settingsModal.addEventListener('click', (event) => { if (event.target === settingsModal) settingsModal.classList.remove('open'); }); }
        if (editScriptInfoForm) {
            editScriptInfoForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const newName = document.getElementById('modal-script-name').value;
                if (scriptTitleDisplay && newName.trim()) scriptTitleDisplay.textContent = newName.trim();
                showMessage('剧本信息已更新 (模拟)', 'success');
                settingsModal.classList.remove('open');
            });
        }

        // --- Checkpoint Parameters Modal Functionality (mostly unchanged, ensure it's a single modal instance) ---
        const checkpointParamsModal = document.getElementById('checkpoint-params-modal');
        const closeCheckpointParamsModalBtn = document.getElementById('close-checkpoint-params-modal-btn');
        const cancelCheckpointParamsBtn = document.getElementById('cancel-checkpoint-params-btn');
        const checkpointParamsForm = document.getElementById('checkpoint-params-form');
        const expandNegativePromptBtn = document.getElementById('expand-negative-prompt');
        const negativePromptTextarea = document.getElementById('param-negative-prompt');

        if (closeCheckpointParamsModalBtn) closeCheckpointParamsModalBtn.addEventListener('click', () => checkpointParamsModal.classList.remove('open'));
        if (cancelCheckpointParamsBtn) cancelCheckpointParamsBtn.addEventListener('click', () => checkpointParamsModal.classList.remove('open'));
        if (checkpointParamsModal) checkpointParamsModal.addEventListener('click', (event) => { if (event.target === checkpointParamsModal) checkpointParamsModal.classList.remove('open'); });
        if (checkpointParamsForm) {
            checkpointParamsForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const params = { /* ... collect params ... */ };
                console.log('Checkpoint Parameters Applied:', params);
                showMessage('Checkpoint 参数已应用 (模拟)', 'success');
                checkpointParamsModal.classList.remove('open');
            });
        }
        if (expandNegativePromptBtn && negativePromptTextarea) {
            expandNegativePromptBtn.addEventListener('click', () => {
                negativePromptTextarea.rows = negativePromptTextarea.rows === 2 ? 5 : 2;
                expandNegativePromptBtn.textContent = negativePromptTextarea.rows === 2 ? '展开' : '收起';
            });
        }
        
        // --- Dynamic Content Addition (Placeholder for Roles/Storyboards - unchanged) ---
        const addRoleBtn = document.getElementById('add-role-btn');
        const addStoryboardBtn = document.getElementById('add-storyboard-btn');
        if(addRoleBtn) { /* ... unchanged ... */ }
        if(addStoryboardBtn) { /* ... unchanged ... */ }

    </script>
</body>
</html>
